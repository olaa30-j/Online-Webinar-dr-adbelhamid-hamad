// Webinar Registration System Config
const CONFIG = {
    APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbzmuctpf-wvcIimvSykxwCWu9yv0R4ustyJGhAUiL206ojcou6s8X-wdN1UJ6y9gPay/exec",
    WEBINAR_TITLE: "ุฃูู ุงูุฃุนุตุงุจ ุงูุณูุฑู: ุฃุญุฏุซ ุทุฑู ุงูุชุดุฎูุต ูุงูุนูุงุฌ",
    WEBINAR_DATE: "15 ููููู 2025",
    WEBINAR_TIME: "7:00 ูุณุงุกู ุจุชูููุช ููุฏุง",
    WEBINAR_LINK: "https://zoom.us/j/123456789",
    COMPANY_NUMBER: "201200241817",
    COMPANY_EMAIL: "olaadel.967@gmail.com",
    WEBSITE_NAME: "ูููุน_ุงููุฏูุงุช_ุงูุทุจูุฉ",

    COUNTRIES: [
        { code: "EG", name: "ูุตุฑ", dialCode: "20", flag: "๐ช๐ฌ" },
        { code: "SA", name: "ุงูุณุนูุฏูุฉ", dialCode: "966", flag: "๐ธ๐ฆ" },
        { code: "AE", name: "ุงูุฅูุงุฑุงุช", dialCode: "971", flag: "๐ฆ๐ช" },
        { code: "KW", name: "ุงููููุช", dialCode: "965", flag: "๐ฐ๐ผ" },
        { code: "QA", name: "ูุทุฑ", dialCode: "974", flag: "๐ถ๐ฆ" }
    ]
};

const WHATSAPP_MESSAGE_TEMPLATE = `ูุฑุญุจุงู {name}ุ

ุดูุฑุงู ูุชุณุฌููู ูู ูุฏูุชูุง "${CONFIG.WEBINAR_TITLE}"

ุงูุชูุงุตูู:
๐ ุงูุชุงุฑูุฎ: ${CONFIG.WEBINAR_DATE}
โฐ ุงูููุช: ${CONFIG.WEBINAR_TIME}
๐ ุฑุงุจุท ุงููุฏูุฉ: ${CONFIG.WEBINAR_LINK}

ูุฃู ุงุณุชูุณุงุฑุงุชุ ูุง ุชุชุฑุฏุฏ ูู ุงูุชูุงุตู ูุนูุง.

ูุน ุชุญูุงุชุ
ูุฑูู ${CONFIG.WEBINAR_TITLE}`;

// Global variables
let lastSubmissionTime = 0;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initForm();
    initCountdown();
    initChat();
    initSwiper();
    
    // Show hidden countdown if exists
    const hiddenCountdown = document.querySelector('.countdown-timer[style="display: none;"]');
    if (hiddenCountdown) {
        hiddenCountdown.style.display = 'block';
    }
});

// Initialize Swiper
function initSwiper() {
    var swiper = new Swiper('.swiper-container', {
        slidesPerView: 1,
        spaceBetween: 20,
        loop: true,
        autoplay: {
            delay: 3000,
            disableOnInteraction: false,
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        breakpoints: {
            640: {
                slidesPerView: 2,
            },
            992: {
                slidesPerView: 3,
            }
        }
    });
}

// Initialize Chat
function initChat() {
    // ุชุฃุซูุฑุงุช ุตูุชูุฉ
    const messageSound = document.getElementById('messageSound');
    const chatModal = document.getElementById('chatModal');
    const fixedChatBtn = document.getElementById('fixedChatBtn');
    const fixedWhatsappBtn = document.getElementById('fixedWhatsappBtn');
    const closeChatBtn = document.getElementById('closeChatBtn');
    const minimizeChatBtn = document.getElementById('minimizeChatBtn');

    // ุจูุงูุงุช ุงูุฃุณุฆูุฉ ูุงูุฃุฌูุจุฉ
    const faqData = {
        answer1: {
            question: "ูุง ูู ูุฏุฉ ุงููุฏูุฉุ",
            answer: "ูุฏุฉ ุงููุฏูุฉ ุณุงุนุฉ ูุงุญุฏุฉ ูุงููุฉุ ุชุชุถูู:<br><br>" +
                "โข 40 ุฏูููุฉ ุนุฑุถ ุชูุฏููู ููุตู<br>" +
                "โข 20 ุฏูููุฉ ููุฃุณุฆูุฉ ูุงูุฃุฌูุจุฉ ุงููุจุงุดุฑุฉ<br><br>" +
                "ูุณุชุญุตู ุฎูุงููุง ุนูู ูุนูููุงุช ูููุฉ ุชุบููู ุนู ุณุงุนุงุช ุทูููุฉ ูู ุงูุจุญุซ."
        },
        answer2: {
            question: "ูู ุงููุฏูุฉ ูุฌุงููุฉ ุญูุงูุ",
            answer: "ูุนูุ ุงููุฏูุฉ ูุฌุงููุฉ ุจุงููุงูู ุจุฏูู ุฃู ุชูุงููู ุฎููุฉ.<br><br>" +
                "ููุฏููุง ูุฌุฒุก ูู ูุณุคูููุชูุง ุงููุฌุชูุนูุฉ ููุดุฑ ุงููุนู ุงูุตุญู.<br><br>" +
                "ูู ูุง ูุทูุจู ูู ูุดุงุฑูุชู ุงููุนุงูุฉ ูุงูุงุณุชูุงุฏุฉ ุงููุตูู ูู ุงููุญุชูู."
        },
        answer3: {
            question: "ููู ูููููู ุงููุดุงุฑูุฉ ูู ุงููุฏูุฉุ",
            answer: "ุฎุทูุงุช ุงููุดุงุฑูุฉ ุจุณูุทุฉ:<br><br>" +
                "1. ุณุฌู ุจูุงูุงุชู ุนุจุฑ ุงููููุฐุฌ ุงูููุฌูุฏ ุจุงูุตูุญุฉ<br>" +
                "2. ุณูุฑุณู ูู ุฑุงุจุท ุงูุฒููู ุนูู ุงููุงุชุณุงุจ ูุจู ุงููุฏูุฉ<br>" +
                "3. ุงูุถู ุจุงูุฑุงุจุท ูู ุงูููุนุฏ ุงููุญุฏุฏ<br><br>" +
                "ุณูุชู ุฅุฑุณุงู ุชุฐููุฑ ูุจู ุณุงุนุฉ ูู ุงูุจุฏุก."
        },
        answer4: {
            question: "ูู ูููููู ุงูุญุตูู ุนูู ุชุณุฌูู ูููุฏูุฉุ",
            answer: "ุจุงูุทุจุน!<br><br>" +
                "โข ุณูุชู ุฅุฑุณุงู ุชุณุฌูู ุงููุฏูุฉ ูุฌููุน ุงููุณุฌููู<br>" +
                "โข ุงูุชุณุฌูู ูุชุงุญ ููุฏุฉ 7 ุฃูุงู ุจุนุฏ ุงููุฏูุฉ<br>" +
                "โข ููููู ุทูุจ ูุณุฎุฉ ุฎุงุตุฉ ููุงุจู ุฑุณูู ุฑูุฒูุฉ ุฅุฐุง ุฃุฑุฏุช ุญูุธูุง ููุฃุจุฏ"
        }
    };

    // ูุชุญ ุงูุดุงุช ูุน ุชุฃุซูุฑ ุตูุชู
    if (fixedChatBtn) {
        fixedChatBtn.addEventListener('click', function() {
            chatModal.classList.add('active');
            if (messageSound) messageSound.play();

            // ุฅุธูุงุฑ ูุคุดุฑ ุงููุชุงุจุฉ ููุญุงูุงุฉ ุงูุดุงุช ุงูุญูููู
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) typingIndicator.classList.add('active');

            setTimeout(() => {
                if (typingIndicator) typingIndicator.classList.remove('active');
            }, 1500);
        });
    }

    // ุฒุฑ ุงููุงุชุณุงุจ
    if (fixedWhatsappBtn) {
        fixedWhatsappBtn.addEventListener('click', function() {
            window.location.href = 'https://wa.me/14039987830';
        });
    }

    // ุฅุบูุงู ุงูุดุงุช
    if (closeChatBtn) {
        closeChatBtn.addEventListener('click', function() {
            chatModal.classList.remove('active');
        });
    }

    // ุชุตุบูุฑ ุงูุดุงุช
    if (minimizeChatBtn) {
        minimizeChatBtn.addEventListener('click', function() {
            chatModal.classList.remove('active');
            setTimeout(() => {
                const badge = fixedChatBtn.querySelector('.notification-badge');
                if (badge) badge.style.display = 'flex';
            }, 300);
        });
    }

    // ุงูุชุนุงูู ูุน ุงูุฃุณุฆูุฉ ุงูุณุฑูุนุฉ
    document.querySelectorAll('.quick-question').forEach(question => {
        question.addEventListener('click', function() {
            const answerId = this.getAttribute('data-answer');
            const faq = faqData[answerId];

            // ุฅุถุงูุฉ ุงูุณุคุงู ูุฑุณุงูุฉ ูู ุงููุณุชุฎุฏู
            addMessage(faq.question, 'sent');

            // ุฅุธูุงุฑ ูุคุดุฑ ุงููุชุงุจุฉ
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) typingIndicator.classList.add('active');

            // ูุญุงูุงุฉ ููุช ุงููุชุงุจุฉ
            setTimeout(() => {
                if (typingIndicator) typingIndicator.classList.remove('active');
                addMessage(faq.answer, 'received');
                if (messageSound) messageSound.play();
            }, 1500);
        });
    });

    // ุฏุงูุฉ ูุฅุถุงูุฉ ุฑุณุงูุฉ ุฌุฏูุฏุฉ
    function addMessage(text, type) {
        const chatBody = document.querySelector('.chat-body');
        if (!chatBody) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">${text}</div>
                <div class="message-time">${getCurrentTime()}</div>
            </div>
        `;

        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // ุฏุงูุฉ ููุญุตูู ุนูู ุงูููุช ุงูุญุงูู
    function getCurrentTime() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'ู' : 'ุต';
        hours = hours % 12;
        hours = hours ? hours : 12;
        return `${hours}:${minutes} ${ampm}`;
    }

    setTimeout(() => {
        if (chatModal && !chatModal.classList.contains('active')) {
            const badge = fixedChatBtn.querySelector('.notification-badge');
            if (badge) badge.style.display = 'flex';
        }
    }, 30000);
}

// Countdown initialization
function initCountdown() {
    // Parse Arabic date from CONFIG
    const webinarDate = parseArabicDate(CONFIG.WEBINAR_DATE + " " + CONFIG.WEBINAR_TIME) || 
                       new Date('June 15, 2025 19:00:00 GMT-0400'); // Fallback for Canada time
    
    function updateCountdown() {
        const now = new Date().getTime();
        const distance = webinarDate - now;

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Update all days elements
        document.querySelectorAll('.days').forEach(el => {
            el.textContent = days.toString().padStart(2, '0');
        });
        
        // Update all hours elements
        document.querySelectorAll('.hours').forEach(el => {
            el.textContent = hours.toString().padStart(2, '0');
        });
        
        // Update all minutes elements
        document.querySelectorAll('.minutes').forEach(el => {
            el.textContent = minutes.toString().padStart(2, '0');
        });
        
        // Update all seconds elements
        document.querySelectorAll('.seconds').forEach(el => {
            el.textContent = seconds.toString().padStart(2, '0');
        });

        if (distance < 0) {
            clearInterval(countdownTimer);
            document.querySelectorAll('.countdown-container, .countdown-timer').forEach(container => {
                container.innerHTML = `
                    <div class="ended-message">
                        <h3 class="font-bold">ุงููุฏูุฉ ูุฏ ุจุฏุฃุช!</h3>
                        <p>ููููู ุงูุงูุถูุงู ุงูุขู ุนุจุฑ ุงูุฑุงุจุท ุงูุชุงูู:</p>
                        <a href="${CONFIG.WEBINAR_LINK}" class="text-red-600 font-bold underline mt-2 inline-block">
                            ุงูุถู ุฅูู ุงููุฏูุฉ
                        </a>
                    </div>
                `;
            });
        }
    }

    let countdownTimer = setInterval(updateCountdown, 1000);
    updateCountdown(); // Initial call
}

// Function to parse Arabic date strings
function parseArabicDate(dateString) {
    const arabicMonths = {
        'ููุงูุฑ': 0, 'ูุจุฑุงูุฑ': 1, 'ูุงุฑุณ': 2, 'ุฃุจุฑูู': 3, 'ูุงูู': 4, 'ููููู': 5,
        'ููููู': 6, 'ุฃุบุณุทุณ': 7, 'ุณุจุชูุจุฑ': 8, 'ุฃูุชูุจุฑ': 9, 'ููููุจุฑ': 10, 'ุฏูุณูุจุฑ': 11
    };
    
    const timeParts = {
        'ุตุจุงุญุงู': 'AM',
        'ูุณุงุกู': 'PM'
    };
    
    try {
        const dateMatch = dateString.match(/(\d{1,2})\s+(\S+)\s+(\d{4})\s+(\d{1,2}):(\d{2})\s+(\S+)/);
        if (!dateMatch) return null;
        
        const [, day, arabicMonth, year, hour, minute, timePart] = dateMatch;
        const month = arabicMonths[arabicMonth];
        const ampm = timeParts[timePart] || 'AM';
        
        let hour24 = parseInt(hour);
        if (ampm === 'PM' && hour24 < 12) hour24 += 12;
        if (ampm === 'AM' && hour24 === 12) hour24 = 0;
        
        return new Date(year, month, day, hour24, minute, 0);
    } catch (e) {
        console.error("Error parsing Arabic date:", e);
        return null;
    }
}

// Form validation and submission
function initForm() {
    const form = document.getElementById('webinar-form');
    if (!form) {
        console.error('Form not found!');
        return;
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit(e).catch(error => {
            console.error('Form submission error:', error);
            alert(`ุญุฏุซ ุฎุทุฃ: ${error.message}`);
        });
    });

    document.getElementById('name')?.addEventListener('blur', validateName);
    document.getElementById('phone')?.addEventListener('blur', validatePhone);
    document.getElementById('country')?.addEventListener('change', validatePhone);
}

async function validateName() {
    const nameInput = document.getElementById('name');
    const errorElement = document.getElementById('name-error');
    const name = nameInput.value.trim();

    if (!name) {
        showError(errorElement, 'ุงูุงุณู ูุทููุจ');
        return false;
    }

    if (name.length < 3) {
        showError(errorElement, 'ุงูุงุณู ูุฌุจ ุฃู ูููู 3 ุฃุญุฑู ุนูู ุงูุฃูู');
        return false;
    }

    hideError(errorElement);
    return true;
}

async function validatePhone() {
    const countrySelect = document.getElementById('country');
    const phoneInput = document.getElementById('phone');
    const errorElement = document.getElementById('phone-error');
    const countryCode = countrySelect.value;
    const phoneNumber = phoneInput.value.replace(/\D/g, '');

    let isValid = true;
    let errorMessage = '';

    if (!phoneNumber) {
        isValid = false;
        errorMessage = 'ุฑูู ุงููุงุชู ูุทููุจ';
    } else {
        switch (countryCode) {
            case 'EG':
                if (!/^(12|15|11|10)\d{8,9}$/.test(phoneNumber)) {
                    isValid = false;
                    errorMessage = 'ุฑูู ูุตุฑ ูุฌุจ ุฃู ูุจุฏุฃ ุจ 11, 15, 12 ุฃู 10 ููุชููู ูู 10-11 ุฑูู';
                }
                break;
            case 'SA':
            case 'AE':
                if (!/^5\d{8}$/.test(phoneNumber)) {
                    isValid = false;
                    errorMessage = 'ุฑูู ุงูุฎููุฌ ูุฌุจ ุฃู ูุจุฏุฃ ุจ 5 ููุชููู ูู 9 ุฃุฑูุงู';
                }
                break;
            case 'KW':
                if (!/^[569]\d{7}$/.test(phoneNumber)) {
                    isValid = false;
                    errorMessage = 'ุฑูู ุงููููุช ูุฌุจ ุฃู ูุจุฏุฃ ุจ 5, 6 ุฃู 9 ููุชููู ูู 8 ุฃุฑูุงู';
                }
                break;
            case 'QA':
                if (!/^[3-7]\d{7}$/.test(phoneNumber)) {
                    isValid = false;
                    errorMessage = 'ุฑูู ูุทุฑ ูุฌุจ ุฃู ูุจุฏุฃ ุจ 3-7 ููุชููู ูู 8 ุฃุฑูุงู';
                }
                break;
        }
    }

    if (isValid) {
        const selectedCountry = CONFIG.COUNTRIES.find(c => c.code === countryCode);
        document.getElementById('full-phone-number').value = `+${selectedCountry.dialCode}${phoneNumber}`;
        hideError(errorElement);
    } else {
        showError(errorElement, errorMessage);
    }

    return isValid;
}

function showError(element, message) {
    if (!element) return;
    element.textContent = message;
    element.classList.remove('hidden');
}

function hideError(element) {
    if (!element) return;
    element.classList.add('hidden');
}

async function handleFormSubmit(e) {
    const isNameValid = await validateName();
    const isPhoneValid = await validatePhone();

    if (!isNameValid || !isPhoneValid) {
        throw new Error('ุงูุฑุฌุงุก ุชุตุญูุญ ุงูุฃุฎุทุงุก ูู ุงููููุฐุฌ');
    }

    const now = Date.now();
    if (now - lastSubmissionTime < 5000) {
        throw new Error('ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ 5 ุซูุงูู ุจูู ูู ูุญุงููุฉ');
    }
    lastSubmissionTime = now;

    const formData = getFormData();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ุฌุงุฑู ุงูุชุณุฌูู...';

    try {
        const result = await submitToGoogleAppsScript(formData);
        
        if (result.status !== 'success') {
            throw new Error(result.message || 'ูุดู ูู ุงูุชุณุฌูู');
        }

        handleSuccess(formData);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function getFormData() {
    const countrySelect = document.getElementById('country');
    const selectedCountry = CONFIG.COUNTRIES.find(c => c.code === countrySelect.value);
    const phoneInput = document.getElementById('phone').value.replace(/\D/g, '');

    return {
        name: document.getElementById('name').value.trim(),
        whatsapp: `+${selectedCountry.dialCode}${phoneInput}`,
        country: selectedCountry.name,
        website: CONFIG.WEBSITE_NAME
    };
}

async function submitToGoogleAppsScript(data) {
    try {
        const formData = new URLSearchParams();
        for (const key in data) {
            if (data[key]) formData.append(key, data[key]);
        }

        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData.toString()
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        return await response.json();
    } catch (error) {
        console.error('Error submitting to Google Apps Script:', error);
        return {
            status: 'error',
            message: error.message || 'ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู'
        };
    }
}

function handleSuccess(formData) {
    localStorage.setItem('webinarRegistration', JSON.stringify({
        name: formData.name,
        whatsapp: formData.whatsapp,
        webinarTitle: CONFIG.WEBINAR_TITLE,
        webinarDate: CONFIG.WEBINAR_DATE,
        webinarTime: CONFIG.WEBINAR_TIME,
        webinarLink: CONFIG.WEBINAR_LINK,
        expiryDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000)  
    }));

    // sendWhatsAppMessage(formData.whatsapp, formData.name);
    window.location.href = 'thankyou.html';
}

function sendWhatsAppMessage(number, name) {
    try {
        const message = WHATSAPP_MESSAGE_TEMPLATE
            .replace('{name}', name)
            .replace('{webinar_title}', CONFIG.WEBINAR_TITLE)
            .replace('{webinar_date}', CONFIG.WEBINAR_DATE)
            .replace('{webinar_time}', CONFIG.WEBINAR_TIME)
            .replace('{webinar_link}', CONFIG.WEBINAR_LINK);

        const cleanNumber = number.replace(/\D/g, '');
        const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(message)}`;
        
        window.open(whatsappUrl, '_blank');
    } catch (error) {
        console.error('Failed to send WhatsApp message:', error);
    }
}